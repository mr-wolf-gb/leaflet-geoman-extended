<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Custom Map Context Menu - Leaflet Geoman</title>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="../dist/leaflet-geoman.css" />
  
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    #map {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    
    /* Custom context menu styles */
    .custom-map-context-menu {
      position: fixed;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      padding: 8px 0;
      min-width: 200px;
      z-index: 10000;
    }
    
    .custom-map-context-menu-item {
      padding: 10px 20px;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .custom-map-context-menu-item:hover {
      background-color: #f0f0f0;
    }
    
    .custom-map-context-menu-separator {
      height: 1px;
      background-color: #e0e0e0;
      margin: 4px 0;
    }
    
    .info-panel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      max-width: 350px;
    }
    
    .info-panel h3 {
      margin: 0 0 15px 0;
      font-size: 18px;
      color: #333;
    }
    
    .info-panel p {
      margin: 0 0 10px 0;
      font-size: 14px;
      line-height: 1.6;
      color: #555;
    }
    
    .highlight {
      background: #ffeb3b;
      padding: 2px 6px;
      border-radius: 3px;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  
  <div class="info-panel">
    <h3>üñ±Ô∏è Custom Map Context Menu</h3>
    <p><span class="highlight">Right-click</span> anywhere on the map to see custom menu options!</p>
    <p>Available actions:</p>
    <ul style="margin: 10px 0; padding-left: 20px; font-size: 13px;">
      <li>Move (M)</li>
      <li>Insert message here</li>
      <li>Show coordinates</li>
      <li>Center map here</li>
      <li>Zoom in</li>
      <li>Zoom out</li>
    </ul>
    <p style="font-size: 12px; color: #999; margin-top: 15px;">
      Note: "Share center of map" and "Selection Tool" are excluded from this menu.
    </p>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="../dist/leaflet-geoman.js"></script>
  
  <script>
    // Initialize the map
    const map = L.map('map').setView([51.505, -0.09], 13);
    
    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors',
      maxZoom: 19
    }).addTo(map);
    
    // Add Leaflet Geoman controls
    map.pm.addControls({
      position: 'topleft',
      drawMarker: true,
      drawPolygon: true,
      drawPolyline: true,
      drawRectangle: true,
      drawCircle: true,
      editMode: true,
      dragMode: true,
      removalMode: true
    });
    
    // Custom context menu implementation
    let customContextMenu = null;
    
    function showCustomMapContextMenu(e) {
      // Remove existing menu if any
      hideCustomMapContextMenu();
      
      // Create context menu
      customContextMenu = document.createElement('div');
      customContextMenu.className = 'custom-map-context-menu';
      
      // Store the click coordinates
      const clickLatLng = e.latlng;
      
      // Define menu items (excluding "Share center of map" and "Selection Tool")
      const menuItems = [
        {
          text: 'Move (M)',
          icon: '‚ÜîÔ∏è',
          onClick: () => {
            alert('Move mode activated! (This would enable drag mode)');
            // You can implement: map.pm.enableGlobalDragMode();
          }
        },
        {
          text: 'Insert message here',
          icon: 'üí¨',
          onClick: () => {
            const message = prompt('Enter your message:');
            if (message) {
              L.popup()
                .setLatLng(clickLatLng)
                .setContent(message)
                .openOn(map);
            }
          }
        },
        { separator: true },
        {
          text: 'Show coordinates',
          icon: 'üìç',
          onClick: () => {
            const lat = clickLatLng.lat.toFixed(6);
            const lng = clickLatLng.lng.toFixed(6);
            L.popup()
              .setLatLng(clickLatLng)
              .setContent(`<strong>Coordinates:</strong><br>Lat: ${lat}<br>Lng: ${lng}`)
              .openOn(map);
          }
        },
        {
          text: 'Center map here',
          icon: 'üéØ',
          onClick: () => {
            map.setView(clickLatLng, map.getZoom());
          }
        },
        { separator: true },
        {
          text: 'Zoom in',
          icon: 'üîç',
          onClick: () => {
            map.zoomIn();
          }
        },
        {
          text: 'Zoom out',
          icon: 'üîé',
          onClick: () => {
            map.zoomOut();
          }
        }
      ];
      
      // Create menu items
      menuItems.forEach(item => {
        if (item.separator) {
          const separator = document.createElement('div');
          separator.className = 'custom-map-context-menu-separator';
          customContextMenu.appendChild(separator);
        } else {
          const menuItem = document.createElement('div');
          menuItem.className = 'custom-map-context-menu-item';
          menuItem.innerHTML = `${item.icon} ${item.text}`;
          
          menuItem.addEventListener('click', (evt) => {
            evt.stopPropagation();
            item.onClick();
            hideCustomMapContextMenu();
          });
          
          customContextMenu.appendChild(menuItem);
        }
      });
      
      // Position the context menu
      customContextMenu.style.left = e.originalEvent.clientX + 'px';
      customContextMenu.style.top = e.originalEvent.clientY + 'px';
      
      document.body.appendChild(customContextMenu);
      
      // Adjust position if menu goes off screen
      setTimeout(() => {
        const rect = customContextMenu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
          customContextMenu.style.left = (window.innerWidth - rect.width - 10) + 'px';
        }
        if (rect.bottom > window.innerHeight) {
          customContextMenu.style.top = (window.innerHeight - rect.height - 10) + 'px';
        }
      }, 0);
      
      // Close menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', hideCustomMapContextMenu);
        document.addEventListener('contextmenu', hideCustomMapContextMenu);
      }, 0);
    }
    
    function hideCustomMapContextMenu() {
      if (customContextMenu) {
        document.removeEventListener('click', hideCustomMapContextMenu);
        document.removeEventListener('contextmenu', hideCustomMapContextMenu);
        customContextMenu.remove();
        customContextMenu = null;
      }
    }
    
    // Add right-click event to map
    map.on('contextmenu', (e) => {
      // Check if the click was on the map itself (not on a layer)
      if (e.originalEvent.target.classList.contains('leaflet-container') ||
          e.originalEvent.target.classList.contains('leaflet-tile') ||
          e.originalEvent.target.classList.contains('leaflet-tile-pane')) {
        showCustomMapContextMenu(e);
      }
    });
    
    // Add some sample shapes for testing
    setTimeout(() => {
      const polygon = L.polygon([
        [51.509, -0.08],
        [51.503, -0.06],
        [51.51, -0.047]
      ]).addTo(map);
      
      polygon.bindPopup('Sample Polygon - Right-click on it for layer menu');
      
      const marker = L.marker([51.5, -0.09]).addTo(map);
      marker.bindPopup('Sample Marker');
      
      console.log('‚úì Sample shapes added');
      console.log('üëâ Right-click on the MAP (not on shapes) to see custom context menu!');
    }, 500);
  </script>
</body>
</html>
